# Education项目总结13-在线学习HLS

# 1.视频点播解决方案

## 1.1.流媒体

所谓流媒体是指采用**流式传输**的方式在Internet播放的媒体格式.流媒体又叫流式媒体,它是指商家用一个视频传送服务器把节目当成数据包发出,传送到网络上.用户通过解压设备对这些数据进行解压后,节目就会像发送前那样显示出来.

概括理解:流媒体就是将视频文件分成许多小块,将这些小块作为数据包通过网络发送出去,实现一边传输视频数据包,一边观看视频.

* 流式传输:就是客户端通过连接视频服务器实时传输音视频信息,实现边下载边播放;

  * 顺序流式传输:

    即顺序下载音视频文件,可以实现边下载边播放,不过,用户只能观看已下载的视频内容,无法快进到未下载的视频部分,顺序流式传输可以使用Http服务器来实现,比如Nginx,Apache等.

  * 实时流式传输:

    实时流式传输可以解决顺序流式传输无法快进的问题,他与Http流式传输不同,它必须使用流媒体服务器并且使用流媒体协议来传输视频,它比Http流式传输复杂.常见的实时流式传输协议有RTSP,RTMP,RSVP等;

* 流媒体系统的概要结构:

  ![image-20200514220703688](https://fechin-leyou.oss-cn-beijing.aliyuncs.com/PicGo/image-20200514220703688.png)

1. 将原始的是视频文件通过编码器转换为适合网络传输的流格式,编码后的视频直接输送给媒体服务器;原始的视频文件通常都是事先录制好的视频,比如通过摄像机,摄像头等录像,录音设备采集到的音视频文件,体积较大,要想在网络上传输需要经过压缩处理,即通过编码器进行编码;
2. 媒体服务获取到编码好的视频文件,对外提供流媒体视频传输接口,接口协议包括:HTTP,RTSP,RTMP等;
3. 播放器通过流媒体协议与媒体服务器通信,获取视频数据,播放视频;

## 1.2.点播方案

本项目包括点播和直播两种方式,点播方案如下:

1. 播放器通过http协议从http服务器上下载视频文件进行播放;

   问题:必须等到视频下载完成才可以播放,不支持快进到某个时间点进行播放.

2. 播放器通过rtmp协议连接媒体服务器以实时流方式播放视频;

   使用rtmp协议需要架设媒体服务器,造价高,对于直播多采用此方案;

3. 播放器使用HLS协议连接到http服务器实现近实时流方式播放视频:

   HLS协议规定:基于Http协议,视频封装格式为ts,视频的编码格式为H264,音频编码格式为mp3,AAC或者AC-3;

## 1.3.HLS

HLS的工作方式是将视频拆分成若干ts格式的小文件,通过m3u8格式的索引文件对这些ts小文件建立索引,一般10s一个ts文件,播放器连接m3u8文件播放,当快进时通过m3u8即可找到对应的索引文件,并去下载对应的ts文件,从而实现快进,快退以近实时的方式播放视频.

![image-20200514221949492](https://fechin-leyou.oss-cn-beijing.aliyuncs.com/PicGo/image-20200514221949492.png)

# 2.视频编码

## 2.1视频编码格式

**文件格式**:是指`.MP4`,`.avi`,`.rmvb`等这些不同扩展名的视频文件的文件格式,视频文件的内容主要包括视频和音频,其文件格式是按照一定的编码格式去编码,并且按照该文件锁规定的封装格式将视频,音频,字幕等信息封装在一起,播放器会根据它们的封装格式去提取出编码,然后由播放器编码,最终播放音视频;

**音视频编码格式**:通过音视频的压缩技术,将视频格式转换成另一种视频格式,通过视频编码实现流媒体的传输.

MPEG系列(由ISO国际标准组织机构下属的MPEG运动图像专家组开发)视频编码方面主要是MPEG1(VCD),MPEG2(DVD),MPEG4,MPEG-AVC(热门);音频编码方面主要是MPEG Audio Layer 1/2,MPEG Audio Layer 3(MP3),MPEG-2 AAC,MPEG-4 ACC等等;

H.26X系列(由ITU国际电传视讯联盟主导,侧重网络传输,注意只是视频编码)包括H.261,H.262.H.263,H.263+,H.263++,H.264

目前最常用的编码标准是视频H.264,音频AAC.

## 2.2.FFmpeg的基本使用

我们将视频录制完成后,使用视频编码软件对视频进行编码,本项目使用FFmpeg对视频进行编码.FFmpeg是一套可以用来记录,转化数字音频,视频并将其转化为流的开源计算机程序.

## 2.3.生成m3u8/ts文件

使用ffempeg生成m3u8的步骤如下:

1. 先将avi视频转成mp4.

   ```shell
   ffmpeg -i lucene.avi -c:v libx264 -s 1280x720 -pix_fmt yuv420p -b:a 63k -b:v 753k -r 18 ./lucene.mp4
   ```

   `-c:v`视频编码为x264,x264编码是H264的一种开源编码格式;

   `-s`设置分辨率;

   `-pix_fmt yuv420p`:设置像素采样方式,主流的采样方式有三种,YUV4:4:4,YUV4:2:2,YUV4:2:0,它的作用是根据采样方式从码流中还原每个像素点的YUV(亮度信息与色彩信息)值;

   `-b`:设置码率,-b:a和-b:v分别表示音频的码率和视频的码率,-b表示音频加视频的总码率.码率对一个视频质量有很大的作用;

   `-r`:帧率, 表示每秒更新图像画面的次数,通常大于24肉眼就没有连贯与停顿的感觉了;

2. 将mp4生成m3u8.

   ~~~shell
   ffmpeg -i lucene.mp4 -hls_time 10 -hls_list_size 0 -hls_segment_filename ./hls/lucene_%05d.ts ./hls/lucene.m3u8
   ~~~

   `-his_time`:设置每片的长度,单位为秒;

   `-his_list_size n`:保存的分片的数量,设置为0表示保存所有分片;

   `-his_segment_filename`:段文件的名称,%05d表示5位数字;

   生成的效果是:将lucene.mp4视频文件每10s生成一个ts文件,最后生成一个m3u8文件,m3u8文件是ts的索引文件;

### 2.3.1.码率的设置

码率又叫比特率即每秒传输的bit数,单位为bps(Bit Per Second),码率越大传送数据的速度越快.码率的计算公式:`文件大小(转成bit)/时长(秒)/1024=kbps`即每秒传输千位数;

# 3. 播放器

视频编码后要使用播放器对其进行解码,播放视频内容,在web应用中常用的播放器有flash播放器,h5播放器或浏览器插件播放器,其中以flash和h5播放器最常见.

flash播放器:缺点是需要在客户机安装Adobe Flash Player播放器,优点是flash播放器已经很成熟了,并且浏览器对flash支持也很好;

H5播放器:基于h5自带video标签进行构建,优点是大部分浏览器支持h5,不用再安装第三方播放器,并且随着前端技术的发展,h5技术会越来越成熟;

本项目采用H5播放器,使用Video.js开源播放器.

Video.js是一款基于HTML5的网络视频播放器,它支持HTML5和Flash视频,它支持在台式机和移动设备上播放视频.

## 3.1.搭建媒体服务器

正常使用video.js播放视频是通过一个网页,用户通过浏览器打开网页去播放视频,网页和视频都从web服务器请求,通常视频的url地址使用单独的域名

## 3.2.Nginx媒体服务器

HLS协议基于Http协议,本项目使用Nginx作为视频服务器,下图是Nginx媒体服务器的配置流程图:

![image-20200518173030702](https://fechin-leyou.oss-cn-beijing.aliyuncs.com/PicGo/image-20200518173030702.png)

# 4.媒资管理

## 4.1.需求分析

目前媒资管理的主要管理对象是课程录播视频,包括:媒资文件的查询,视频上传,视频删除,视频处理;

下面是媒资系统与其它系统的交互情况:

![image-20200516122133066](https://fechin-leyou.oss-cn-beijing.aliyuncs.com/PicGo/image-20200516122133066.png)

## 4.2.开发环境(略)

## 4.3.上传文件

### 4.3.1.断点续传解决方案

![image-20200516125521891](https://fechin-leyou.oss-cn-beijing.aliyuncs.com/PicGo/image-20200516125521891.png)

上传流程如下:

1. 上传前先把文件分成块;
2. 一块一块的上传,上传中断后重新上传,已上传的分块不用再上传;
3. 各分块上传完成最后合并文件;

文件下载同理.

### 4.3.2.文件分块与合并

文件分块的流程如下:

1. 获取源文件长度;
2. 根据设定的分块文件的大小计算出快速;
3. 从源文件读取数据依次向每一个块文件写数据;

### 4.3.3.前端页面

#### 4.3.3.1.WebUploader介绍

![image-20200516132640673](https://fechin-leyou.oss-cn-beijing.aliyuncs.com/PicGo/image-20200516132640673.png)

使用WebUploader上传流程如下:

![image-20200516132727158](https://fechin-leyou.oss-cn-beijing.aliyuncs.com/PicGo/image-20200516132727158.png)

### 4.3.4.媒资业务流程

1. 上传前检查上传环境:

检查文件是否上传,已上传则直接返回;检查文件上传路径是否存在,不存在则创建;

2. 分块检查:

检查分块文件是否上传,已上传则返回true.未上传则检查上传路径是否存在,不存在则创建;

3. 分块上传:

将分块文件上传到指定的路径;

4. 合并分块:

将所有分块文件合并为一个文件,在数据库记录文件信息;

