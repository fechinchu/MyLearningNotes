# 15-Spring Security Oauth2

# 1.用户认证需求分析

## 1.1.用户认证与授权

用户通过在线学习页面点播视频进行学习,如何去记录学生的学习过程.要想掌握学生的学习情况需要知道用户的身份信息,记录哪个用户在什么时间学习了什么课程,如果用户要购买课程也需要知道用户的身份信息.所以,去管理学生的学习过程最基本的是要实现用户的身份认证.

## 1.2.单点登录需求

本项目包括多个子项目,如:学习系统,教学管理中心,系统管理中心等,为了提高用户体验性需要实现用户只认证一次便可以在多个拥有访问权限的系统中访问,这个功能叫做单点登录.

单点登录(Single Sign On),简称为SSO,是目前比较流行的企业业务整合的解决方案之一,SSO的定义是在多个应用系统中,用户只需要登录一次就可以访问所有相互信任的应用系统.

![image-20200519101917471](https://fechin-leyou.oss-cn-beijing.aliyuncs.com/PicGo/image-20200519101917471.png)

## 1.3.第三方认证需求

作为互联网项目难免需要访问外部系统的资源,同样本系统也要访问第三方系统的资源接口,场景如下:

一个微信用户没有在学习在线注册,本系统可以通过请求微信系统来验证该用户的身份,验证通过后该用户便可在本系统学习,它的基本流程如下:

![image-20200519102202061](https://fechin-leyou.oss-cn-beijing.aliyuncs.com/PicGo/image-20200519102202061.png)

从上图可以看出,微信不属于本系统,本系统没有存储微信用户的账号,密码等信息.本系统如果要获取该用户的基本信息则需要首先通过微信的认证系统进行认证,微信认证通过后本系统便可获取该微信用户的基本信息.从而在本系统将该微信用户的头像,昵称等信息显示出来,该用户便不用再本系统注册确可以直接学.

# 2.用户认证技术方案

## 2.1.单点登录技术方案

分布式系统要实现单点登录,通常将认证系统独立抽取出来,并且将用户身份信息存储在单独的存储介质,比如MySQL,Redis,考虑性能要求,通常存储在Redis中,如下图:

![image-20200519102905250](https://fechin-leyou.oss-cn-beijing.aliyuncs.com/PicGo/image-20200519102905250.png)

Java中有很多用户认证的框架可以实现单点登录:

1. Apache Shiro;
2. CAS;
3. Spring Security CAS;

## 2.2.Oauth2认证

### 2.2.1.Oauth2认证流程

第三方认证技术方案最主要解决认证协议的通用标准问题,因为要实现跨系统认证,各系统之间要遵循一定的接口协议.

Oauth协议为用户资源的授权提供了一个安全的,开放而简易的标准.同时,任何第三方都可以使用Oauth认证服务,任何服务提供商都可以实现自身的Oauth认证服务,因而Oauth是开放的,业界提供了Oauth的多种实现,大大节约程序员的时间,因而Oauth是简易的.互联网很多服务如Open API,现在OAUTH标准逐渐成为开放资源授权的标准.

![image-20200519111759171](https://fechin-leyou.oss-cn-beijing.aliyuncs.com/PicGo/image-20200519111759171.png)

1. 客户端请求第三方授权

   用户进入登录页面,点击微信的图标以微信账号登录系统,用户是自己在微信里信息的资源拥有者.

2. 资源拥有者统一给客户端授权

   资源拥有者扫描二维码表示资源拥有者同意给客户端授权,微信会对资源拥有者的身份进行认证,认证通过后,微信会询问用户是否授权给该网站访问自己的微信数据,用户点击"确认登录"表示同意授权,微信认证服务器会颁发一个授权码,并重定向到需要登录的网站.

3. 客户端获取到授权码,请求认证服务器申请令牌

   此过程看不到,客户端应用程序请求认证服务器,请求携带授权码.

4. 认证服务器向客户端响应令牌

   认证服务器验证了客户端请求的授权码,如果合法则给客户端颁发令牌,令牌是客户端访问资源的通行证.此交互过程用户看不到,当客户端拿到令牌后,用户在需要登录的网站看到已经登录成功;

5. 客户端请求资源服务器的资源

   客户端携带令牌访问资源服务器的资源.登录网站携带令牌请求访问微信服务器获取用户的基本信息;

6. 资源服务器返回受保护资源

   资源服务器校验令牌的合法性,如果合法向用户响应资源信息内容.

![image-20200519113209454](https://fechin-leyou.oss-cn-beijing.aliyuncs.com/PicGo/image-20200519113209454.png)

Oauth2包括以下角色:

1. 客户端:本身不存储资源,需要通过资源拥有者的授权去请求资源服务器的资源,比如:学成在线Android客户端,学成在线的Web客户端(浏览器),微信客户端等;
2. 资源拥有者:通常为用户,也可以是应用程序,即该资源的拥有者;
3. 授权服务器(认证服务器):用来对资源拥有者的身份进行认证,对访问资源进行授权.客户端要想访问资源需要通过认证服务器对资源拥有者授权后方可访问;
4. 资源服务器:存储资源的服务器,比如:学成网用户管理服务器存储了学成网的用户信息.微信的资源服务存储了微信的用户信息,客户端最终访问资源服务器获取资源信息

## 2.3.Spring Security Oauth2认证解决方案

本项目采用Spring Security+Oauth2完成用户认证及用户授权,Spring Security是一个强大的和高度可定制的身份验证和访问控制框架,Spring Security框架集成了Oauth2协议,下图是项目认证的流程图:

![image-20200519114139412](https://fechin-leyou.oss-cn-beijing.aliyuncs.com/PicGo/image-20200519114139412.png)

1. 用户请求认证服务完成认证;
2. 认证服务下发用户身份令牌,拥有身份令牌表示身份合法;
3. 用户携带令牌请求资源服务,请求资源服务必先经过网关;
4. 网关效验用户身份令牌的合法,不合法表示用户没有授权,如果合法则放行继续访问.
5. 资源服务获取令牌,根据令牌完成授权;
6. 资源服务完成授权则相应资源信息;

# 3.Spring Security Oauth2研究

## 3.1.Oauth2授权码模式



